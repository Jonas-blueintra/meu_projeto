(function (tinymce) {

	function getParsedElementFromString(string) {
		return (new DOMParser().parseFromString(string, 'text/html')).body.firstChild;
	}

	function Plugin(editor) {
		this.settings = {
			$selector: '.rgb-incorporar-media-container',
			fullWidthClass: 'is-full-width',
		}

		this.showDialog = this.showDialog.bind(this);
		this.render = this.render.bind(this);

		var plugin = this;
		plugin.editor = editor;

		editor.addButton('rgb_incorporar_media', {
			icon: 'media',
			text: 'Incorporar Media',
			title: 'Incorporar Media',
			stateSelector: this.settings.$selector,
			onclick: plugin.showDialog
		})
	}


	Plugin.prototype.showDialog = function () {
		var editor = this.editor;
		var dom = editor.dom;
		var params = this.data = {
			iframe: '',
			isFullWidth: false,
		};

		var iframe = (editor.selection.getNode()).querySelector('iframe');

		if (iframe) {
			var parentWrapper = dom.getParent(iframe, this.settings.$selector);

			params.iframe = iframe.outerHTML;
			params.isFullWidth = parentWrapper && parentWrapper.classList.contains(this.settings.fullWidthClass)
		}

		editor.windowManager.open({
			width: 600,
			height: 160,
			title: 'Incorporar Media',
			data: params,
			body: [
				{
					type: 'label',
					label: 'Insira o código de incorporação abaixo:',
				},
				{
					type: 'textbox',
					name: 'iframe',
					multiline: true,
				},
				{
					type: 'checkbox',
					name: 'isFullWidth',
					text: 'Utilizar 100% da largura disponível do container',
				},
			],

			onsubmit: this.onsubmit.bind(this)
		});

		this.render();
	}

	Plugin.prototype.render = function () {
	}

	Plugin.prototype.onsubmit = function (e) {
		this.data = e.data;

		var editor = this.editor;
		var dom = editor.dom;

		var selectedNode = editor.selection.getNode();
		var parentWrapper = dom.getParent(selectedNode, this.settings.$selector);

		if (parentWrapper) {
			var updatedParentWrapper = getParsedElementFromString(this.getHtml(this.data));
			
			dom.replace(updatedParentWrapper, parentWrapper);
		} else {
			editor.insertContent(this.getHtml(this.data));
		}
	}

	Plugin.prototype.getHtml = function (data) {

		var elementString = data.iframe;

		var elementNode = getParsedElementFromString(elementString);

		var width = elementNode.width || 1920;
		var height = elementNode.height || 1080;

		var wrapperPositioningClass = data.isFullWidth ? 'is-full-width' : 'is-centered';

		var aspectRatioPadding = 'padding-top: ' + ((height / width) * 100) + '%';

		var mediaWidth = '';
		if (!data.isFullWidth) {
			mediaWidth = 'width: ' + width + 'px';
		}

		var html = '<div class="rgb-incorporar-media-container ' + wrapperPositioningClass + '">';
		html += 		'<div class="rgb-incorporar-media" style="' + mediaWidth +'">';
		html += 			'<div class="rgb-incorporar-media-inner">';
		html += 				elementString;
		html +=				'</div>';
		html +=			'</div>';
		html +=		'</div>';
		html +=		'<p>&nbsp;</p>';

		return html;
	}

	tinymce.create('tinymce.plugins.rgb_incorporar_media', {
		init: function (editor) {
			return new Plugin(editor)
		},
	});

	tinymce.PluginManager.add('rgb_incorporar_media', tinymce.plugins.rgb_incorporar_media);

})(window.tinymce);